<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-advanced-guide/complex-query-model-and-optimisation">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Complex Query Models and Execution Tuning | INOS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://inos2023.github.io/en/img/编组4.svg"><meta data-rh="true" name="twitter:image" content="https://inos2023.github.io/en/img/编组4.svg"><meta data-rh="true" property="og:url" content="https://inos2023.github.io/en/docs/advanced-guide/complex-query-model-and-optimisation"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Complex Query Models and Execution Tuning | INOS"><meta data-rh="true" name="description" content="Complex query execution model"><meta data-rh="true" property="og:description" content="Complex query execution model"><link data-rh="true" rel="icon" href="/en/img/01-1LOGO.svg"><link data-rh="true" rel="canonical" href="https://inos2023.github.io/en/docs/advanced-guide/complex-query-model-and-optimisation"><link data-rh="true" rel="alternate" href="https://inos2023.github.io/en/docs/advanced-guide/complex-query-model-and-optimisation" hreflang="en"><link data-rh="true" rel="alternate" href="https://inos2023.github.io/docs/advanced-guide/complex-query-model-and-optimisation" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://inos2023.github.io/docs/advanced-guide/complex-query-model-and-optimisation" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="INOS RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="INOS Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BYY7CCPJZ6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-BYY7CCPJZ6",{})</script><link rel="stylesheet" href="/en/assets/css/styles.0f429e90.css">
<link rel="preload" href="/en/assets/js/runtime~main.2aaddb75.js" as="script">
<link rel="preload" href="/en/assets/js/main.b3642fec.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_Rzz1" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/logo.png" alt="INOS Logo" class="themedImage_DeRy themedImage--light_hbln"><img src="/en/img/logo.png" alt="INOS Logo" class="themedImage_DeRy themedImage--dark_qgR1"></div><b class="navbar__title text--truncate">Intelligence Native Group</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/en/docs/introduction/main-principle-concepts">Docs</a><a class="navbar__item navbar__link" href="/en/blog">Blog</a><a class="navbar__item navbar__link" href="/en/community">Community</a><a class="navbar__item navbar__link" href="/en/users">Users</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">English</a><ul class="dropdown__menu"><li><a href="/en/docs/advanced-guide/complex-query-model-and-optimisation" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/docs/advanced-guide/complex-query-model-and-optimisation" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-cn">中文（中国）</a></li></ul></div><a href="https://github.com/inos2023/inos2023.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"><span>GitHub</span></a><a class="navbar__item navbar__link search-input" href="/en/docs/introduction/recommended-use-case"><div class="SearchBarClass"><img src="/img/01-11搜索.svg" width="18px" height="18px"><input class="inputClass" placeholder="搜索"></div></a><div class="toggle_HPIb colorModeToggle_KItF"><button class="clean-btn toggleButton_yRlM toggleButtonDisabled_oHIz" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_Vljy"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_lcNQ"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_mmj0"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_NWrx docsWrapper_oNqO"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_LsNq" type="button"></button><div class="docPage_fHU4"><aside class="theme-doc-sidebar-container docSidebarContainer_jEGB"><div class="sidebarViewport_Gc0S"><div class="sidebar_uCr1"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_s63m"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/en/docs/introduction/main-principle-concepts">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/en/docs/quick-start/basic-database-operations">Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/en/docs/sql-syntax/ansi-compatibility">SQL Syntax</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/en/docs/basic-guide/background-task-management">Basic Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/en/docs/advanced-guide/0.2.0_s3_upgrade_checklist">Advanced Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/advanced-guide/0.2.0_s3_upgrade_checklist">Byconity 0.2.0 s3 storage upgrade checklist</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/advanced-guide/background-task-configuration">Background Tasks Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/advanced-guide/bucket-table-best-practice">Bucket table best practice manual</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/advanced-guide/column-based-storage">Column Storage Design Principles</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/en/docs/advanced-guide/complex-query-model-and-optimisation">Complex Query Models and Execution Tuning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/advanced-guide/import-optimisation">Import Optimisation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/advanced-guide/managing-concurrency">Transactions and Concurrency Control</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/advanced-guide/query-optimiser">Query Optimizer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/advanced-guide/rbac">Role-based Access Control (RBAC)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/en/docs/advanced-guide/resource-manager">resource manager</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/en/docs/community/become-maintainer">Community</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/en/docs/deployment/deployment-requirements">Deployment</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/en/docs/meetup/gpgpu-related-tools">Meetup 活动</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_b8RI"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_QMJw"><div class="docItemContainer_EkDS"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_dvLu" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/en/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_ObZR"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Advanced Guides</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Complex Query Models and Execution Tuning</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_Iw4v theme-doc-toc-mobile tocMobile_L4iJ"><button type="button" class="clean-btn tocCollapsibleButton_Omde">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Complex query model and execution tuning</h1><h2 class="anchor anchorWithStickyNavbar_B0by" id="complex-query-execution-model">Complex query execution model<a href="#complex-query-execution-model" class="hash-link" aria-label="Direct link to Complex query execution model" title="Direct link to Complex query execution model">​</a></h2><p><img loading="lazy" src="/en/assets/images/boxcnUIHT3GY66QcCm0sXdVUrxc-9adadd60bf95fe79b67512fe58018575.png" width="1070" height="462" class="img_astN"></p><p><strong>Complex query execution model diagram</strong></p><p>Analytical queries can be classified into simple and complex queries. Simple queries typically involve retrieving and aggregating data from a single table, as well as joining large and small tables, with fast query response times. Complex queries, on the other hand, involve large tables, multiple table associations, and complex logic processing, often with slow query response times and high resource consumption. ByConity is optimized for complex queries.</p><p>For simple queries, a two-stage execution model is used, with the partial stage executed on the computing node and the final stage executed on the service node. However, when executing complex queries involving multiple aggregations or joins, the flexibility of the two-stage execution model is limited, making query optimization challenging. To better support distributed queries and facilitate the execution of the execution plan generated by the optimizer, we have introduced complex queries that support multiple rounds of distributed execution mode.</p><p>The execution flow of a complex query is as follows:</p><ul><li>Query SQL String is parsed into AST by parser</li><li>Rewrite and optimize AST to generate an execution plan</li><li>When the optimizer is enabled, an execution plan is generated by the optimizer.</li><li>Divide the execution plan into multiple PlanSegments</li><li>PlanSegment is an execution segment in the distributed execution process, which contains</li><li>The AST fragment required for execution, or a logical execution plan fragment composed of PlanNode</li><li>Node information for PlanSegment execution</li><li>The upstream and downstream information of PlanSegment, which includes the upstream input flow and the input flow required by the downstream</li><li>The engine&#x27;s scheduler will form these PlanSegments into a DAG, and then distribute them to all nodes in the cluster according to topological sorting</li><li>After each node receives the PlanSegment, it starts to drive the execution of the PlanSegment</li><li>The PlanSegment containing the data source starts to read the data, and distributes the data to the downstream nodes according to certain shuffle rules</li><li>The PlanSegment containing the exchange input waits for upstream data, and if it needs to continue to shuffle, it will continue to send the data to each node</li><li>After multiple rounds of stages are completed, the results will be returned to the server</li></ul><h2 class="anchor anchorWithStickyNavbar_B0by" id="how-to-enable-it">How to enable it<a href="#how-to-enable-it" class="hash-link" aria-label="Direct link to How to enable it" title="Direct link to How to enable it">​</a></h2><p>Enabling the optimizer will automatically follow the complex query execution model. It can be enabled by configuring enable_optimizer=1, or dialect_type=&#x27;ANSI&#x27;.</p><ul><li>Make sure statistics exist</li></ul><p>Without statistics, the resulting query plan is suboptimal. <code>show stats [&lt;db_name&gt;.]&lt;table_name&gt;</code></p><ul><li>Analyze the time spent on each Step of the plan</li></ul><p>The time-consuming of each Step can be displayed by <code>explain analyze sql</code></p><ul><li>Exchange parameter tuning</li></ul><p>Exchange operators are responsible for data transfer between PlanSegments.</p><p><code>exchange_source_pipeline_threads</code> affects the total number of threads executed by the pipeline, especially for non-source pipelines (referring to pipelines that directly read data from storage). Currently, the default setting is the number of CPU cores. There is currently no ideal recommended value. You can consider /2 or \ *2 Observation results. If the query memory usage is large, it can be adjusted down.</p><p><code>exchange_timeout_ms</code> Exchange timeout time (ms), the default is 100s, if there is an Exchange-related timeout error, you can increase it appropriately</p><p><code>exchange_unordered_output_parallel_size</code> affects the concurrency of exchange output data, the default is 8, and generally does not need to be adjusted. If the adjustment of exchange_source_pipeline_threads is relatively large, you can appropriately increase exchange_unordered_output_parallel_size to increase the upstream output capacity.</p><p><code>exchange_enable_block_compress</code> Whether to enable exchange compression, it is enabled by default, if the CPU bottleneck is more obvious than the network, you can try to turn it off</p><h2 class="anchor anchorWithStickyNavbar_B0by" id="reference-documentation">Reference Documentation<a href="#reference-documentation" class="hash-link" aria-label="Direct link to Reference Documentation" title="Direct link to Reference Documentation">​</a></h2></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_HAaO padding--none margin-left--sm"><li class="tag_Ut5_"><a class="tag_sQub tagRegular_dfhI" href="/en/docs/tags/docs">Docs</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/inos2023/blog/docs/advanced-guide/complex-query-model-and-optimisation.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_O9Og" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_DEFe"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/en/docs/advanced-guide/column-based-storage"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Column Storage Design Principles</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/en/docs/advanced-guide/import-optimisation"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Import Optimisation</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_Q7NC thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#complex-query-execution-model" class="table-of-contents__link toc-highlight">Complex query execution model</a></li><li><a href="#how-to-enable-it" class="table-of-contents__link toc-highlight">How to enable it</a></li><li><a href="#reference-documentation" class="table-of-contents__link toc-highlight">Reference Documentation</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 ZJLab.</div></div></div></footer></div>
<script src="/en/assets/js/runtime~main.2aaddb75.js"></script>
<script src="/en/assets/js/main.b3642fec.js"></script>
</body>
</html>